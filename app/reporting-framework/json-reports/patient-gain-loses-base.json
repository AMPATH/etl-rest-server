{
    "name": "patientGainLosesBaseReport",
    "version": "1.0",
    "tag": "patient-gain-loses",
    "description": "Patient gains and loses",
    "uses": [
        {
            "name": "patientGainLoseDatasetOne",
            "version": "1.0",
            "type": "dataset_def1"
        },
        {
            "name": "patientGainLoseDatasetTwo",
            "version": "1.0",
            "type": "dataset_def2"
        }
    ],
    "sources": [
        {
            "dataSet": "patientGainLoseDatasetTwo",
            "alias": "t3"
        },
        {
            "dataSet": "patientGainLoseDatasetOne",
            "alias": "t4",
            "join": {
                "type": "LEFT",
                "joinCondition": "t4.person_id = t3.person_id"
            }
        }
    ],
    "columns": [
        {
            "type": "simple_column",
            "alias": "person_id",
            "column": "t3.person_id"
        },
        {
            "type": "simple_column",
            "alias": "person_uuid",
            "column": "person_uuid"
        },
        {
            "type": "simple_column",
            "alias": "starting_month",
            "column": "starting_month"
        },
        {
            "type": "simple_column",
            "alias": "ending_month",
            "column": "ending_month"
        },
        {
            "type": "simple_column",
            "alias": "starting_status",
            "column": "starting_status"
        },
        {
            "type": "simple_column",
            "alias": "ending_status",
            "column": "ending_status"
        },
        {
            "type": "derived_column",
            "alias": "starting_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "ending_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "(IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0))"
            }
        },
        {
            "type": "derived_column",
            "alias": "starting_not_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "transferred_out",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ending_status = 'transfer_out' THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "transferred_in",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ((CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END) = 1 AND t3.transfer_in_date BETWEEN '{startingMonth}' AND '{endingMonth}') THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "newly_enrolled",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ((CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END) = 1 AND (CASE WHEN ((CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END) = 1 AND t3.transfer_in_date BETWEEN '{startingMonth}' AND '{endingMonth}') THEN 1 ELSE 0 END) = 0 AND t3.enrollment_date BETWEEN '{startingMonth}' AND '{endingMonth}') THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "returned_to_care",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN (CASE WHEN ((CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END) = 1 AND (CASE WHEN ((CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END) = 1 AND t3.transfer_in_date BETWEEN '{startingMonth}' AND '{endingMonth}') THEN 1 ELSE 0 END) = 0 AND t3.enrollment_date BETWEEN '{startingMonth}' AND '{endingMonth}') THEN 1 ELSE 0 END) = 0 AND (CASE WHEN ((CASE WHEN (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND (IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0)) = 1 THEN 1 ELSE 0 END) = 1 AND t3.transfer_in_date BETWEEN '{startingMonth}' AND '{endingMonth}') THEN 1 ELSE 0 END) = 0 AND (CASE WHEN starting_status = 'active' OR starting_status = 'defaulter' THEN 1 ELSE 0 END) = 0 AND ((IF(ending_status = 'active' OR ending_status = 'defaulter', 1, 0))) = 1 THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "dead",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ending_status = 'dead' THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "ltfu",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ending_status = 'ltfu' THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "still_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ((CASE WHEN (starting_status = 'active' OR starting_status = 'defaulter') THEN 1 ELSE 0 END) = 1) AND ((CASE WHEN (ending_status = 'active' OR ending_status = 'defaulter') THEN 1 ELSE 0 END) = 1) THEN 1 ELSE 0 END"
            }
        },
        {
            "type": "simple_column",
            "alias": "transfer_in_date",
            "column": "t3.transfer_in_date"
        },
        {
            "type": "simple_column",
            "alias": "enrollment_date",
            "column": "t3.enrollment_date"
        }
    ],
    "filters": {
        "conditionJoinOperator": "AND",
        "conditions": [
            {
                "filterType": "tableColumns",
                "conditionExpression": "starting_status = 'active' OR starting_status = 'defaulter' OR starting_status IS NULL"
            },
            {
                "filterType": "tableColumns",
                "conditionExpression": "",
                "parameterName": "endingMonth"
            },
            {
                "filterType": "tableColumns",
                "conditionExpression": "",
                "parameterName": "startingMonth"
            }
        ]
    }
}
