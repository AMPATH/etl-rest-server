{
    "name": "patientGainLosesBaseReport",
    "version": "1.0",
    "tag": "patient-gain-loses",
    "description": "Patient gains and loses",
    "uses": [
        {
            "name": "patientGainLoseDatasetReport",
            "version": "1.0",
            "type": "dataset_def1"
        },
        {
            "name": "patientGainLoseDataset",
            "version": "1.0",
            "type": "dataset_def2"
        }
    ],
    "sources": [
        {
            "dataSet": "patientGainLoseDatasetReport",
            "alias": "t3"
        },
        {
            "dataSet": "patientGainLoseDataset",
            "alias": "t4",
            "join": {
                "type": "LEFT",
                "joinCondition": "t4.person_id = t3.person_id"
            }
        }
    ],
    "columns": [
        {
            "type": "simple_column",
            "alias": "person_id",
            "column": "t3.person_id"
        },
        {
            "type": "simple_column",
            "alias": "person_uuid",
            "column": "person_uuid"
        },
        {
            "type": "simple_column",
            "alias": "starting_month",
            "column": "starting_month"
        },
        {
            "type": "simple_column",
            "alias": "ending_month",
            "column": "ending_month"
        },
        {
            "type": "simple_column",
            "alias": "starting_status",
            "column": "starting_status"
        },
        {
            "type": "simple_column",
            "alias": "ending_status",
            "column": "ending_status"
        },
        {
            "type": "derived_column",
            "alias": "starting_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN (starting_status = 'active' OR starting_status = 'defaulter') THEN @starting_active:=1 ELSE @starting_active:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "ending_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN (ending_status = 'active' OR ending_status = 'defaulter') THEN @ending_active:=1 ELSE @ending_active:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "starting_not_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN @starting_active = 0 and @ending_active = 1 THEN @starting_not_active := 1 ELSE @starting_not_active := 0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "transferred_in",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN @starting_not_active = 1 AND t3.transfer_in_date BETWEEN @startingMonth AND @endingMonth THEN @transferred_in:=1 ELSE @transferred_in:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "newly_enrolled",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN @starting_not_active = 1 AND @transferred_in = 0 AND t3.enrollment_date BETWEEN @startingMonth AND @endingMonth THEN @newly_enrolled:=1 ELSE @newly_enrolled:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "returned_to_care",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN @newly_enrolled = 0 AND @transferred_in = 0 AND @starting_active = 0  AND @ending_active = 1 THEN @returned_to_care:=1 ELSE @returned_to_care:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "transferred_out",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ending_status = 'transfer_out' THEN @transferred_out:=1 ELSE @transferred_out:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "dead",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ending_status = 'dead' THEN @dead:=1 ELSE @dead:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "ltfu",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN ending_status = 'ltfu' THEN @ltfu:=1 ELSE @ltfu:=0 END"
            }
        },
        {
            "type": "derived_column",
            "alias": "still_active",
            "expressionType": "simple_expression",
            "expressionOptions": {
              "expression": "CASE WHEN @starting_active = 1 AND @ending_active = 1 THEN @still_active:=1 ELSE @still_active:=0 END"
            }
        },
        {
            "type": "simple_column",
            "alias": "transfer_in_date",
            "column": "t3.transfer_in_date"
        },
        {
            "type": "simple_column",
            "alias": "enrollment_date",
            "column": "t3.enrollment_date"
        }
    ],
    "filters": {
        "conditionJoinOperator": "AND",
        "conditions": [
            {
                "filterType": "tableColumns",
                "conditionExpression": "starting_status = 'active' OR starting_status = 'defaulter' OR starting_status IS NULL"
            }
        ]
    }
}
