{
  "name": "prep731Base",
  "version": "1.0",
  "tag": "",
  "description": "",
  "uses": [],
  "sources": [
    {
      "table": "etl.prep_monthly_report_dataset",
      "alias": "fps"
    },
    {
      "table": "etl.flat_prep_summary_v1_1",
      "alias": "fp",
      "join": {
        "type": "LEFT",
        "joinCondition": "fps.person_id = fp.person_id"
      }
    },
    {
      "table": "etl.flat_patient_identifiers_v1",
      "alias": "flat_identifiers",
      "join": {
        "type": "LEFT",
        "joinCondition": "fps.person_id = flat_identifiers.patient_id"
      }
    }
  ],
  "columns": [
    {
      "type": "simple_column",
      "alias": "person_id",
      "column": "fps.person_id"
    },
    {
      "type": "simple_column",
      "alias": "ccc_number",
      "column": "flat_identifiers.ccc"
    },
    {
      "type": "simple_column",
      "alias": "upi_number",
      "column": "flat_identifiers.nupi"
    },
    {
      "type": "simple_column",
      "alias": "encounter_datetime",
      "column": "fps.encounter_datetime"
    },
    {
      "type": "derived_column",
      "alias": "prep_new_female_general_pop",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 3, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_male_general_pop",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 3, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_msm",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 5, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_fsw",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 6, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_pwud_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 7, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_pwud_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 7, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_discordant_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_discordant_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_vulnerable_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 8, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_vulnerable_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 8, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_ayp",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 11, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_new_preg_breastfeeding",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 9, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_female_general_pop",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 3  and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_male_general_pop",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 3  and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_msm",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 5 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_fsw",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 6 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_pwud_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 7 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_pwud_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 7 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_discordant_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 1 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_discordant_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 1 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_vulnerable_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 8 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_vulnerable_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.population_type = 8 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_ayp",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 11 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "prep_sti_preg_breastfeeding",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.population_type = 9 and fp.has_sti = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "seroconverted_female",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'F' and fps.turned_positive_this_month = 1, 1, NULL)"
      }
    },
    {
      "type": "derived_column",
      "alias": "seroconverted_male",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fps.gender = 'M' and fps.turned_positive_this_month = 1, 1, NULL)"
      }
    }
  ],
  "filters": {
    "conditionJoinOperator": "and",
    "conditions": [
      {
        "filterType": "tableColumns",
        "conditionExpression": "fps.enrolled_in_prep_this_month = 1"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fps.endDate = ?",
        "parameterName": "endDate"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fps.location_id in ?",
        "parameterName": "locations"
      }
    ]
  },
  "groupBy": {
    "groupParam": "groupByParam",
    "columns": ["fps.person_id"]
  }
}
