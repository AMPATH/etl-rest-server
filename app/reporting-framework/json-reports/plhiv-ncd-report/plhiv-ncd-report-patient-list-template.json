{
  "name": "plhiv-ncd-report-patient-list-template",
  "version": "1.0",
  "tag": "plhiv-ncd-report-patient-list-template",
  "description": "",
  "sources": [
    {
      "table": "amrs.person",
      "alias": "t1"
    },
    {
      "table": "amrs.person_name",
      "alias": "person_name",
      "join": {
        "type": "LEFT",
        "joinCondition": "t1.person_id = person_name.person_id AND (person_name.voided IS NULL || person_name.voided = 0) AND person_name.preferred = 1"
      }
    },
    {
      "table": "amrs.patient_identifier",
      "alias": "id",
      "join": {
        "type": "LEFT",
        "joinCondition": "t1.person_id = id.patient_id AND (id.voided IS NULL || id.voided = 0)"
      }
    },
    {
      "table": "amrs.person_attribute",
      "alias": "contacts",
      "join": {
        "type": "LEFT",
        "joinCondition": "t1.person_id = contacts.person_id AND (contacts.voided IS NULL || contacts.voided = 0) AND contacts.person_attribute_type_id in (10, 48)"
      }
    },
    {
      "table": "amrs.person_address",
      "alias": "pa",
      "join": {
        "type": "LEFT",
        "joinCondition": "t1.person_id = pa.person_id"
      }
    },
    {
      "table": "etl.hiv_monthly_report_dataset_v1_2",
      "alias": "hmrd",
      "join": {
        "type": "LEFT",
        "joinCondition": "t1.person_id = hmrd.person_id"
      }
    },
    {
      "table": "(SELECT fli.person_id, fli.hiv_viral_load as vl_1, fli.test_datetime as vl_1_date FROM etl.flat_labs_and_imaging fli INNER JOIN (SELECT person_id, MAX(test_datetime) AS max_vl_1_date,max(encounter_id) as encounter_id FROM etl.flat_labs_and_imaging fli where fli.hiv_viral_load is not null GROUP BY person_id) max_dates ON fli.person_id = max_dates.person_id AND fli.test_datetime = max_dates.max_vl_1_date AND fli.encounter_id = max_dates.encounter_id)",
      "alias": "vl",
      "join": {
        "type": "LEFT",
        "joinCondition": "hmrd.person_id = vl.person_id"
      }
    }
  ],
  "columns": [
    {
      "type": "simple_column",
      "alias": "patient_uuid",
      "column": "t1.uuid"
    },
    {
      "type": "derived_column",
      "alias": "uuid",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "t1.uuid"
      }
    },
    {
      "type": "simple_column",
      "alias": "person_id",
      "column": "t1.person_id"
    },
    {
      "type": "simple_column",
      "alias": "gender",
      "column": "t1.gender"
    },
    {
      "type": "simple_column",
      "alias": "status",
      "column": "hmrd.status"
    },
    {
      "type": "simple_column",
      "alias": "enrollment_date",
      "column": "date_format(hmrd.enrollment_date, '%Y-%m-%d')"
    },
    {
      "type": "derived_column",
      "alias": "person_name",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": " CONCAT(COALESCE(person_name.given_name, ''), ' ', COALESCE(person_name.middle_name, ''), ' ', COALESCE(person_name.family_name, ''))"
      }
    },
    {
      "type": "derived_column",
      "alias": "age",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "TIMESTAMPDIFF(YEAR,t1.birthdate,CURDATE())"
      }
    },
    {
      "type": "derived_column",
      "alias": "identifiers",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": " GROUP_CONCAT(DISTINCT id.identifier SEPARATOR ', ')"
      }
    },
    {
      "type": "derived_column",
      "alias": "phone_number",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": " GROUP_CONCAT(DISTINCT contacts.value SEPARATOR ', ')"
      }
    },
    {
      "type": "simple_column",
      "alias": "nearest_center",
      "column": "pa.address3"
    },
    {
      "type": "derived_column",
      "alias": "vl_category",
      "expressionType": "case_statement",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "vl.vl_1 < 50",
            "value": "LDL"
          },
          {
            "condition": "(vl.vl_1 >= 50 and vl.vl_1 < 200)",
            "value": "Low Risk Low Level Viremia"
          },
          {
            "condition": "(vl.vl_1 >= 200 and vl.vl_1 < 1000)",
            "value": "High Risk Low Level Viremia"
          },
          {
            "condition": "(vl.vl_1 > 1000)",
            "value": "Suspected Treatment Failure"
          }
        ]
      }
    }
  ],
  "groupBy": {
    "columns": ["t1.person_id"]
  }
}
