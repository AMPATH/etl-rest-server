{
  "name": "breastCancerMonthlySummaryBase",
  "version": "1.0",
  "tag": "breast_cancer_monthly_summary_base",
  "uses": [],
  "sources": [
    {
      "table": "etl.flat_breast_cancer_screening_test",
      "alias": "fbcs"
    },
    {
      "table": "amrs.person_name",
      "alias": "patient_name",
      "join": {
        "type": "inner",
        "joinCondition": "fbcs.person_id = patient_name.person_id and (patient_name.voided is null || patient_name.voided = 0)"
      }
    },
    {
      "table": "amrs.patient_identifier",
      "alias": "patient_id",
      "join": {
        "type": "inner",
        "joinCondition": "fbcs.person_id = patient_id.patient_id and (patient_id.voided is null || patient_id.voided = 0)"
      }
    },
    {
      "table": "amrs.location",
      "alias": "l",
      "join": {
        "type": "inner",
        "joinCondition": "l.location_id = fbcs.location_id"
      }
    },
    {
      "table": "amrs.person_attribute",
      "alias": "p",
      "join": {
        "type": "left",
        "joinCondition": "fbcs.person_id = p.person_id and (p.voided is null || p.voided = 0 and (p.person_attribute_type_id = 10))"
      }
    }
  ],
  "columns": [
    {
      "type": "simple_column",
      "alias": "person_id",
      "column": "fbcs.person_id"
    },
    {
      "type": "derived_column",
      "alias": "person_name",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "concat(coalesce(patient_name.given_name, ''), ' ', coalesce(patient_name.middle_name, ''), ' ', coalesce(patient_name.family_name, ''))"
      }
    },
    {
      "type": "simple_column",
      "alias": "phone_number",
      "column": "p.value"
    },
    {
      "type": "derived_column",
      "alias": "identifiers",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "group_concat(distinct patient_id.identifier separator ', ')"
      }
    },
    {
      "type": "simple_column",
      "alias": "gender",
      "column": "fbcs.gender"
    },
    {
      "type": "simple_column",
      "alias": "age",
      "column": "fbcs.age"
    },
    {
      "type": "simple_column",
      "alias": "location_id",
      "column": "fbcs.location_id"
    },
    {
      "type": "derived_column",
      "alias": "breast_findings_this_visit",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.breast_findings_this_visit = 1115",
            "value": "Normal"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 9689",
            "value": "Fine nodularity"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 9690",
            "value": "Dense nodularity"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 9687",
            "value": "Skin edema"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 9688",
            "value": "Nipple/areolar change"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 5313",
            "value": "Muscle tenderness"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 6493",
            "value": "Nipple discharge"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 582",
            "value": "Breast mass"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 6250",
            "value": "Breast lumps"
          },
          {
            "condition": "fbcs.breast_findings_this_visit = 5622",
            "value": "Other (non-coded)"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "lymph_node_findings",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.lymph_node_findings = 1",
            "value": "Normal"
          },
          {
            "condition": "fbcs.lymph_node_findings = 2",
            "value": "Lymphadenopathy"
          },
          {
            "condition": "fbcs.lymph_node_findings = 3",
            "value": "Fixed"
          },
          {
            "condition": "fbcs.lymph_node_findings = 4",
            "value": "Mobile"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "patient_education",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.patient_education = 9651",
            "value": "Annual screening"
          },
          {
            "condition": "fbcs.patient_education = 9692",
            "value": "Self-examination"
          },
          {
            "condition": "fbcs.patient_education = 2345",
            "value": "Follow-up"
          },
          {
            "condition": "fbcs.patient_education = '2345 ## 9651'",
            "value": "Follow-up, Annual screening"
          },
          {
            "condition": "fbcs.patient_education = '2345 ## 9692'",
            "value": "Follow-up, Self-examination"
          },
          {
            "condition": "fbcs.patient_education = '9651 ## 9692'",
            "value": "Annual screening, Self-examination"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "referrals_ordered",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.referrals_ordered = 0",
            "value": "None"
          },
          {
            "condition": "fbcs.referrals_ordered = 1",
            "value": "Refer to clinician"
          }
        ]
      }
    },
    {
      "type": "simple_column",
      "alias": "referral_date",
      "column": "DATE_FORMAT(fbcs.referral_date, '%Y-%m-%d')"
    },
    {
      "type": "derived_column",
      "alias": "presence_of_chief_complaint",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "presence_of_chief_complaint = 1",
            "value": "Asymptomatic"
          },
          {
            "condition": "presence_of_chief_complaint = 2",
            "value": "Symptomatic"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "breast_finding_location",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "breast_finding_location = 5141",
            "value": "Right"
          },
          {
            "condition": "breast_finding_location = 5139",
            "value": "Left"
          },
          {
            "condition": "breast_finding_location = 9625",
            "value": "Cyclic"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "breast_finding_quadrant",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "breast_finding_quadrant = 8266",
            "value": "Superficial"
          },
          {
            "condition": "breast_finding_quadrant = 8267",
            "value": "Deep"
          },
          {
            "condition": "breast_finding_quadrant = 6589",
            "value": "Upper inner quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 6591",
            "value": "Upper outer quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 6590",
            "value": "Lower inner quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 5622",
            "value": "Other"
          },
          {
            "condition": "breast_finding_quadrant = 5104",
            "value": "Left lower quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 1883",
            "value": "Left upper quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 5017",
            "value": "Right upper quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 1882",
            "value": "Right lower quadrant"
          },
          {
            "condition": "breast_finding_quadrant = 9695",
            "value": "Breast areola"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "history_of_mammogram",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.history_of_mammogram = 0",
            "value": "No"
          },
          {
            "condition": "fbcs.history_of_mammogram = 1",
            "value": "Yes"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "past_mammogram_results",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.past_mammogram_results = 1",
            "value": "Normal"
          },
          {
            "condition": "fbcs.past_mammogram_results = 2",
            "value": "Abnormal"
          },
          {
            "condition": "fbcs.past_mammogram_results = 3",
            "value": "Not done"
          },
          {
            "condition": "past_mammogram_results = 4",
            "value": "Indeterminate"
          },
          {
            "condition": "fbcs.past_mammogram_results = 5",
            "value": "Completed"
          },
          {
            "condition": "fbcs.past_mammogram_results = 6",
            "value": "Unknown"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "history_of_breast_ultrasound",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.history_of_breast_ultrasound = 0",
            "value": "No"
          },
          {
            "condition": "fbcs.history_of_breast_ultrasound = 1",
            "value": "Yes"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "past_breast_ultrasound_results",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.past_breast_ultrasound_results = 1",
            "value": "Normal"
          },
          {
            "condition": "fbcs.past_breast_ultrasound_results = 2",
            "value": "Abnormal"
          },
          {
            "condition": "fbcs.past_breast_ultrasound_results = 3",
            "value": "Unknown"
          },
          {
            "condition": "fbcs.past_breast_ultrasound_results = 4",
            "value": "Not done"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "history_of_breast_biopsy",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.history_of_breast_biopsy = 0",
            "value": "No"
          },
          {
            "condition": "fbcs.history_of_breast_biopsy = 1",
            "value": "Yes"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "past_breast_biopsy_results",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.past_breast_biopsy_results = 1",
            "value": "Normal"
          },
          {
            "condition": "fbcs.past_breast_biopsy_results = 2",
            "value": "Abnormal"
          },
          {
            "condition": "fbcs.past_breast_biopsy_results = 3",
            "value": "Unknown"
          },
          {
            "condition": "fbcs.past_breast_biopsy_results = 4",
            "value": "Benign"
          },
          {
            "condition": "fbcs.past_breast_biopsy_results = 5",
            "value": "Malignant"
          },
          {
            "condition": "fbcs.past_breast_biopsy_results = 6",
            "value": "Not done"
          }
        ]
      }
    },
    {
      "type": "simple_column",
      "alias": "number_of_biopsies_done",
      "column": "number_of_biopsies_done"
    },
    {
      "type": "derived_column",
      "alias": "breast_biopsy_type",
      "expressionType": "simpleExpression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fbcs.breast_biopsy_type = 6510",
            "value": "Core needle biopsy"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 6511",
            "value": "Excisional / surgical biopsy"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 6512",
            "value": "Skin punch biopsy"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 6513",
            "value": "Bone marrow biopsy"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 7190",
            "value": "Fine needle aspiration"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 8184",
            "value": "Breast biopsy"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 10075",
            "value": "Ultrasound guided biopsy"
          },
          {
            "condition": "fbcs.breast_biopsy_type = 10076",
            "value": "CT Scan guided biopsy"
          }
        ]
      }
    },
    {
      "type": "simple_column",
      "alias": "location_uuid",
      "column": "fbcs.location_uuid"
    },
    {
      "type": "simple_column",
      "alias": "location_name",
      "column": "l.name"
    },
    {
      "type": "simple_column",
      "alias": "breast_rtc_date",
      "column": "DATE_FORMAT(fbcs.next_appointment_date, '%Y-%m-%d')"
    },
    {
      "type": "simple_column",
      "alias": "encounter_datetime",
      "column": "DATE_FORMAT(fbcs.encounter_datetime, '%Y-%m-%d')"
    },
    {
      "type": "derived_column",
      "alias": "male_patients",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.gender = 'M', 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "female_patients",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.gender = 'F', 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_negative",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 1, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_status_unknown",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 3, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_positive",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 2, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "normal_findings",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit = 1115 or breast_findings_this_visit is null, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "normal_below_30yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if((breast_findings_this_visit = 1115 or breast_findings_this_visit is null) and age < 30, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "normal_30_to_40yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if((breast_findings_this_visit = 1115 or breast_findings_this_visit is null) and age >= 30 and age <= 40, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "normal_41_to_50yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if((breast_findings_this_visit = 1115 or breast_findings_this_visit is null) and age >= 41 and age <= 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "normal_51_to_69yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if((breast_findings_this_visit = 1115 or breast_findings_this_visit is null) and age >= 51 and age <= 69, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "normal_above_70yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if((breast_findings_this_visit = 1115 or breast_findings_this_visit is null) and age >= 70, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "abnormal_findings",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit != 1115, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "abnormal_below_30yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit != 1115 and age < 30, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "abnormal_30_to_40yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit != 1115 and age >= 30 and age <= 40, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "abnormal_41_to_50yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit != 1115 and age >= 41 and age <= 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "abnormal_51_to_69yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit != 1115 and age >= 51 and age <= 69, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "abnormal_above_70yrs",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(breast_findings_this_visit != 1115 and age >= 70, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_status",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "case when hiv_status=1 then 'HIV Negative' when hiv_status=2 then 'HIV Positive' when hiv_status=3 then 'Unknown' else NULL end"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_positive_below_25",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 2 and age < 25, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_negative_below_25",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 1 and age < 25, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_unknown_below_25",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 3 and age < 30, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_positive_25_to_49",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 2 and age >= 25 and age < 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_negative_25_to_49",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 1 and age >= 25 and age < 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_unknown_25_to_49",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 3 and age >= 25 and age < 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_positive_over_50",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 3 and age > 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_negative_over_50",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 1 and age > 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "hiv_unknown_over_50",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(fbcs.hiv_status = 3 and age > 50, 1, null)"
      }
    },
    {
      "type": "derived_column",
      "alias": "total_reffered_for_followup",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "if(referrals_ordered = 1, 1, NULL)"
      }
    }
  ],
  "filters": {
    "conditionJoinOperator": "and",
    "conditions": [
      {
        "filterType": "tableColumns",
        "conditionExpression": "fbcs.age >= ?",
        "parameterName": "startAge"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fbcs.age <= ?",
        "parameterName": "endAge"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "DATE(fbcs.encounter_datetime) >= ?",
        "parameterName": "startDate"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "DATE(fbcs.encounter_datetime) <= ?",
        "parameterName": "endDate"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fbcs.encounter_type = 86"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fbcs.location_uuid in ?",
        "parameterName": "locationUuids"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fbcs.gender in ?",
        "parameterName": "genders"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "fbcs.location_id not in (195)"
      }
    ]
  },
  "groupBy": {
    "groupParam": "groupByParam",
    "columns": [
      "encounter_id"
    ]
  }
}