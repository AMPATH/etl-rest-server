{
  "name": "hei-register-template",
  "version": "1.0",
  "tag": "hei-register-template",
  "description": "HIV Exposed Infant Register MOH 408",
  "uses": [],
  "sources": [
    {
      "table": "etl.flat_hei_summary",
      "alias": "fhi"
    },
    {
      "table": "amrs.person_name",
      "alias": "p",
      "join": {
        "type": "LEFT",
        "joinCondition": " p.person_id = fhi.person_id"
      }
    },
    {
      "table": "amrs.location",
      "alias": "l",
      "join": {
        "type": "LEFT",
        "joinCondition": "l.location_id = fhi.location_id"
      }
    },
    {
      "table": "amrs.patient_identifier",
      "alias": "pi1",
      "join": {
        "type": "LEFT",
        "joinCondition": "pi1.patient_id = fhi.person_id AND pi1.identifier_type = 46"
      }
    },
    {
      "table": "amrs.patient_identifier",
      "alias": "pi2",
      "join": {
        "type": "LEFT",
        "joinCondition": "pi2.patient_id = fhi.person_id AND pi2.identifier_type = 8"
      }
    },
    {
      "table": "amrs.patient_identifier",
      "alias": "pi3",
      "join": {
        "type": "LEFT",
        "joinCondition": "pi3.patient_id = fhi.person_id AND pi3.identifier_type = 38"
      }
    },
    {
      "table": "amrs.patient_identifier",
      "alias": "pi4",
      "join": {
        "type": "LEFT",
        "joinCondition": "pi4.patient_id = fhi.person_id AND pi4.identifier_type = 45"
      }
    },
    {
      "table": "amrs.person_attribute",
      "alias": "pa",
      "join": {
        "type": "LEFT",
        "joinCondition": "pa.person_id = fhi.person_id AND pa.person_attribute_type_id = 12"
      }
    },
    {
      "table": "amrs.person_attribute",
      "alias": "pa",
      "join": {
        "type": "LEFT",
        "joinCondition": "pa.person_id = fhi.person_id AND pa.person_attribute_type_id = 10"
      }
    }
  ],
  "columns": [
    {
      "type": "simple_column",
      "alias": "person_id",
      "column": "fhi.person_id"
    },
    {
      "type": "simple_column",
      "alias": "date_enrolled",
      "column": "DATE_FORMAT(fhi.date_enrolled,'%Y-%m-%d')"
    },
    {
      "type": "simple_column",
      "alias": "date_of_birth",
      "column": "fhi.birth_date"
    },
    {
      "type": "simple_column",
      "alias": "gender",
      "column": "fhi.gender"
    },
    {
      "type": "simple_column",
      "alias": "upi_number",
      "column": "flat_identifiers.nupi"
    },
    {
      "type": "simple_column",
      "alias": "start_month",
      "column": "DATE_FORMAT(hm.endDate,'%Y-%m')"
    },
    {
      "type": "simple_column",
      "alias": "infant_name",
      "column": " CONCAT(p.given_name,  ' ', p.middle_name, ' ', p.family_name)"
    },
    {
      "type": "simple_column",
      "alias": "location",
      "column": "l.name"
    },
    {
      "type": "simple_column",
      "alias": "birth_certificate_number",
      "column": "pi1.identifier"
    },
    {
      "type": "simple_column",
      "alias": "amrs_number",
      "column": "pi2.identifier"
    },
    {
      "type": "simple_column",
      "alias": "hei_id",
      "column": "pi3.identifier"
    },
    {
      "type": "simple_column",
      "alias": "nupi",
      "column": "pi4.identifier"
    },
    {
      "type": "simple_column",
      "alias": "parent_name",
      "column": "pa.value"
    },
    {
      "type": "simple_column",
      "alias": "Phone_Number",
      "column": "pa2.value"
    },
    {
      "type": "simple_column",
      "alias": "initial_hiv_dna_pcr_order_date",
      "column": "fhi.initial_hiv_dna_pcr_order_date"
    },
    {
      "type": "simple_column",
      "alias": "first_pcr_date",
      "column": "fhi.hiv_dna_pcr_1_date"
    },
    {
      "type": "simple_column",
      "alias": "second_pcr_date",
      "column": "fhi.hiv_dna_pcr_2_date"
    },
    {
      "type": "simple_column",
      "alias": "third_pcr_date",
      "column": "fhi.hiv_dna_pcr_3_date"
    },
    {
      "type": "simple_column",
      "alias": "confirm_pcr_date",
      "column": "fhi.hiv_dna_pcr_4_date"
    },
    {
      "type": "simple_column",
      "alias": "third_pcr_date",
      "column": "fhi.hiv_dna_pcr_3_date"
    },
    {
      "type": "simple_column",
      "alias": "first_antibody_date",
      "column": "fhi.antibody_screen_1_date"
    },
    {
      "type": "simple_column",
      "alias": "second_antibody_date",
      "column": "fhi.antibody_screen_2_date"
    },
    {
      "type": "derived_column",
      "alias": "age_in_weeks_on_first_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "FLOOR(DATEDIFF(fhi.initial_hiv_dna_pcr_order_date, fhi.birth_date) / 7)"
      }
    },
    {
      "type": "derived_column",
      "alias": "results_pcr_first_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_resulted, fhi.hiv_dna_pcr_1) = 664",
            "value": "N"
          },
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_resulted, fhi.hiv_dna_pcr_1) = 703",
            "value": "P"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "age_in_months_on_second_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "(EXTRACT(YEAR FROM fhi.hiv_dna_pcr_2_date) - EXTRACT(YEAR FROM fhi.birth_date)) * 12 + (EXTRACT(MONTH FROM fhi.hiv_dna_pcr_2_date) - EXTRACT(MONTH FROM fhi.birth_date))"
      }
    },
    {
      "type": "derived_column",
      "alias": "age_in_months_on_confirm_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "(EXTRACT(YEAR FROM fhi.hiv_dna_pcr_4_date) - EXTRACT(YEAR FROM fhi.birth_date)) * 12 + (EXTRACT(MONTH FROM fhi.hiv_dna_pcr_4_date) - EXTRACT(MONTH FROM fhi.birth_date))"
      }
    },
    {
      "type": "derived_column",
      "alias": "age_in_months_on_first_antibody",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "(EXTRACT(YEAR FROM fhi.antibody_screen_1_date) - EXTRACT(YEAR FROM fhi.birth_date)) * 12 + (EXTRACT(MONTH FROM fhi.antibody_screen_1_date) - EXTRACT(MONTH FROM fhi.birth_date))"
      }
    },
    {
      "type": "derived_column",
      "alias": "age_in_months_on_second_antibody",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "(EXTRACT(YEAR FROM fhi.antibody_screen_2_date) - EXTRACT(YEAR FROM fhi.birth_date)) * 12 + (EXTRACT(MONTH FROM fhi.antibody_screen_2_date) - EXTRACT(MONTH FROM fhi.birth_date))"
      }
    },
    {
      "type": "derived_column",
      "alias": "results_pcr_second_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_2) = 664",
            "value": "N"
          },
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_2) = 703",
            "value": "P"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "age_in_months_on_third_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": " (EXTRACT(YEAR FROM fhi.hiv_dna_pcr_3_date) - EXTRACT(YEAR FROM fhi.birth_date)) * 12 + (EXTRACT(MONTH FROM fhi.hiv_dna_pcr_3_date) - EXTRACT(MONTH FROM fhi.birth_date))"
      }
    },
    {
      "type": "derived_column",
      "alias": "results_pcr_third_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_3) = 664",
            "value": "N"
          },
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_3) = 703",
            "value": "P"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "results_confirm_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_4) = 664",
            "value": "N"
          },
          {
            "condition": "COALESCE(fhi.hiv_dna_pcr_4) = 703",
            "value": "P"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "results_first_antibody",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "COALESCE(fhi.antibody_screen_1) = 664",
            "value": "N"
          },
          {
            "condition": "COALESCE(fhi.antibody_screen_1) = 703",
            "value": "P"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "results_second_antibody",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "COALESCE(fhi.antibody_screen_2) = 664",
            "value": "N"
          },
          {
            "condition": "COALESCE(fhi.antibody_screen_2) = 703",
            "value": "P"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "age_in_months_on_confirm_pcr",
      "expressionType": "simple_expression",
      "expressionOptions": {
        "expression": "(EXTRACT(YEAR FROM fhi.hiv_dna_pcr_4_date) - EXTRACT(YEAR FROM fhi.birth_date)) * 12 + (EXTRACT(MONTH FROM fhi.hiv_dna_pcr_4_date) - EXTRACT(MONTH FROM fhi.birth_date))"
      }
    },
    {
      "type": "derived_column",
      "alias": "infant_feeding",
      "expressionType": "case_statement",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fhi.infant_feeding_method = 5",
            "value": "BF"
          },
          {
            "condition": "fhi.infant_feeding_method = 17",
            "value": "NBF"
          },
          {
            "condition": "fhi.infant_feeding_method = 15",
            "value": "BF"
          },
          {
            "condition": "fhi.infant_feeding_method = 6",
            "value": "BF"
          },
          {
            "condition": "fhi.infant_feeding_method = 9",
            "value": "BF"
          },
          {
            "condition": "fhi.infant_feeding_method = 8",
            "value": "NBF"
          },
          {
            "condition": "fhi.infant_feeding_method = 3",
            "value": "NBF"
          }
        ]
      }
    },
    {
      "type": "derived_column",
      "alias": "hei_outcome",
      "expressionType": "case_statement",
      "expressionOptions": {
        "caseOptions": [
          {
            "condition": "fhi.hei_outcome = 1",
            "value": "Infected"
          },
          {
            "condition": "fhi.hei_outcome = 2",
            "value": "Uninfected"
          },
          {
            "condition": "fhi.hei_outcome = 3 ",
            "value": "Lost to Follow"
          },
          {
            "condition": "fhi.hei_outcome = 4",
            "value": "Transfer Out"
          },
          {
            "condition": "fhi.hei_outcome = 5",
            "value": "Dead"
          },
          {
            "condition": "fhi.hei_outcome = 6",
            "value": "unknown"
          }
        ]
      }
    }
  ],
  "filters": {
    "conditionJoinOperator": "and",
    "conditions": [
      {
        "filterType": "tableColumns",
        "conditionExpression": "DATE_FORMAT(fhi.birth_date, '%Y-%m') = ?",
        "parameterName": "cohort"
      },
      {
        "filterType": "tableColumns",
        "conditionExpression": "hm.location_id in ? ",
        "parameterName": "locations"
      }
    ]
  },
  "groupBy": {
    "groupParam": "groupByParam",
    "columns": ["fhi.person_id"]
  }
}
